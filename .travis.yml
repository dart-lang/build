# Created with https://github.com/dart-lang/mono_repo
language: dart

# Handcoded, need to update mono_repo to be able to include this. Based on
# https://github.com/travis-ci/travis-ci/issues/6683#issuecomment-251938932.
sudo: required
dist: trusty

jobs:
  include:
    - stage: analyze_and_format
      script: ./tool/travis.sh dartfmt
      env: PKG="build"
      dart: dev
    - stage: analyze_and_format
      script: ./tool/travis.sh dartanalyzer
      env: PKG="build"
      dart: dev
    - stage: analyze_and_format
      script: ./tool/travis.sh dartanalyzer
      env: PKG="build"
      dart: stable
    - stage: unit_test
      script: ./tool/travis.sh test_0
      env: PKG="build"
      dart: dev
    - stage: unit_test
      script: ./tool/travis.sh test_0
      env: PKG="build"
      dart: stable
    - stage: analyze_and_format
      script: ./tool/travis.sh dartfmt
      env: PKG="build_barback"
      dart: dev
    - stage: analyze_and_format
      script: ./tool/travis.sh dartanalyzer
      env: PKG="build_barback"
      dart: dev
    - stage: analyze_and_format
      script: ./tool/travis.sh dartanalyzer
      env: PKG="build_barback"
      dart: stable
    - stage: unit_test
      script: ./tool/travis.sh test_0
      env: PKG="build_barback"
      dart: dev
    - stage: unit_test
      script: ./tool/travis.sh test_0
      env: PKG="build_barback"
      dart: stable
    - stage: analyze_and_format
      script: ./tool/travis.sh dartfmt
      env: PKG="build_config"
      dart: dev
    - stage: analyze_and_format
      script: ./tool/travis.sh dartanalyzer
      env: PKG="build_config"
      dart: dev
    - stage: analyze_and_format
      script: ./tool/travis.sh dartanalyzer
      env: PKG="build_config"
      dart: stable
    - stage: unit_test
      script: ./tool/travis.sh test_0
      env: PKG="build_config"
      dart: dev
    - stage: unit_test
      script: ./tool/travis.sh test_0
      env: PKG="build_config"
      dart: stable
    - stage: analyze_and_format
      script: ./tool/travis.sh dartfmt
      env: PKG="build_modules"
      dart: dev
    - stage: analyze_and_format
      script: ./tool/travis.sh dartanalyzer
      env: PKG="build_modules"
      dart: dev
    - stage: unit_test
      script: ./tool/travis.sh test_0
      env: PKG="build_modules"
      dart: dev
    - stage: analyze_and_format
      script: ./tool/travis.sh dartfmt
      env: PKG="build_resolvers"
      dart: dev
    - stage: analyze_and_format
      script: ./tool/travis.sh dartanalyzer
      env: PKG="build_resolvers"
      dart: dev
    - stage: unit_test
      script: ./tool/travis.sh test_0
      env: PKG="build_resolvers"
      dart: dev
    - stage: unit_test
      script: ./tool/travis.sh test_0
      env: PKG="build_resolvers"
      dart: stable
    - stage: analyze_and_format
      script: ./tool/travis.sh dartfmt
      env: PKG="build_runner"
      dart: dev
    - stage: analyze_and_format
      script: ./tool/travis.sh dartanalyzer
      env: PKG="build_runner"
      dart: dev
    - stage: unit_test
      script: ./tool/travis.sh test_0
      env: PKG="build_runner"
      dart: dev
    - stage: analyze_and_format
      script: ./tool/travis.sh dartfmt
      env: PKG="build_test"
      dart: dev
    - stage: analyze_and_format
      script: ./tool/travis.sh dartanalyzer
      env: PKG="build_test"
      dart: dev
    - stage: analyze_and_format
      script: ./tool/travis.sh dartanalyzer
      env: PKG="build_test"
      dart: stable
    - stage: unit_test
      script: ./tool/travis.sh test_0
      env: PKG="build_test"
      dart: dev
    - stage: unit_test
      script: ./tool/travis.sh test_0
      env: PKG="build_test"
      dart: stable
    - stage: analyze_and_format
      script: ./tool/travis.sh dartfmt
      env: PKG="build_web_compilers"
      dart: dev
    - stage: analyze_and_format
      script: ./tool/travis.sh dartanalyzer
      env: PKG="build_web_compilers"
      dart: dev
    - stage: unit_test
      script: ./tool/travis.sh test_1
      env: PKG="build_web_compilers"
      dart: dev
    - stage: analyze_and_format
      script: ./tool/travis.sh dartanalyzer
      env: PKG="e2e_example"
      dart: dev
    - stage: unit_test
      script: ./tool/travis.sh command
      env: PKG="e2e_example"
      dart: dev
    - stage: e2e_test
      script: ./tool/travis.sh test_0
      env: PKG="e2e_example"
      dart: dev
    - stage: analyze_and_format
      script: ./tool/travis.sh dartfmt
      env: PKG="scratch_space"
      dart: dev
    - stage: analyze_and_format
      script: ./tool/travis.sh dartanalyzer
      env: PKG="scratch_space"
      dart: dev
    - stage: unit_test
      script: ./tool/travis.sh test_0
      env: PKG="scratch_space"
      dart: dev

stages:
  - analyze_and_format
  - unit_test
  - e2e_test

# Only building master means that we don't run two builds for each pull request.
branches:
  only: [master]

cache:
  directories:
    - $HOME/.pub-cache

# Handcoded, need to update mono_repo to be able to include this. Based on
# https://github.com/travis-ci/travis-ci/issues/6683#issuecomment-251938932.
before_install:
 - export CHROME_BIN=/usr/bin/google-chrome
 - export DISPLAY=:99.0
 - sh -e /etc/init.d/xvfb start
 - sudo apt-get update
 - sudo apt-get install -y libappindicator1 fonts-liberation
 - wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
 - sudo dpkg -i google-chrome*.deb
 - "t=0; until (xdpyinfo -display :99 &> /dev/null || test $t -gt 10); do sleep 1; let t=$t+1; done"
