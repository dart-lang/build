# Created with package:mono_repo v3.1.0-beta.1
language: dart

# Custom configuration
addons:
  chrome: stable
before_install:
  - tool/travis_setup.sh
after_failure:
  - tool/report_failure.sh
branches:
  only:
    - master

jobs:
  include:
    - stage: analyze_and_format
      name: mono_repo self validate
      os: linux
      script: "pub global activate mono_repo 3.1.0-beta.1 && pub global run mono_repo generate --validate"
    - stage: analyze_and_format
      name: "SDK: dev; PKGS: _test, _test_common; TASKS: `dartanalyzer --fatal-infos --fatal-warnings .`"
      dart: dev
      os: linux
      env: PKGS="_test _test_common"
      script: tool/ci.sh dartanalyzer_0
    - stage: analyze_and_format
      name: "SDK: dev; PKG: _test_null_safety; TASKS: `dartanalyzer --enable-experiment=non-nullable --fatal-infos --fatal-warnings .`"
      dart: dev
      os: linux
      env: PKGS="_test_null_safety"
      script: tool/ci.sh dartanalyzer_1
    - stage: analyze_and_format
      name: "SDK: dev; PKGS: build, build_config, build_daemon, build_modules, build_resolvers, build_runner, build_runner_core, build_test, build_vm_compilers, build_web_compilers, example, scratch_space; TASKS: [`dartfmt -n --set-exit-if-changed .`, `dartanalyzer --fatal-infos --fatal-warnings .`]"
      dart: dev
      os: linux
      env: PKGS="build build_config build_daemon build_modules build_resolvers build_runner build_runner_core build_test build_vm_compilers build_web_compilers example scratch_space"
      script: tool/ci.sh dartfmt dartanalyzer_0
    - stage: analyze_and_format
      name: "SDK: 2.9.0; PKGS: build, build_config, build_daemon, build_resolvers, build_runner_core, build_test, build_vm_compilers, scratch_space; TASKS: `dartanalyzer --fatal-warnings .`"
      dart: "2.9.0"
      os: linux
      env: PKGS="build build_config build_daemon build_resolvers build_runner_core build_test build_vm_compilers scratch_space"
      script: tool/ci.sh dartanalyzer_2
    - stage: unit_test
      name: "SDK: dev; PKG: _test; TASKS: [`pub run build_runner test -- -p chrome --test-randomize-ordering-seed=random`, `pub run build_runner test -- -p vm test/configurable_uri_test.dart --test-randomize-ordering-seed=random`]"
      dart: dev
      os: linux
      env: PKGS="_test"
      script: tool/ci.sh command_0 command_1
    - stage: unit_test
      name: "SDK: dev; PKG: _test; TASKS: [`pub run build_runner test -- -p chrome --test-randomize-ordering-seed=random`, `pub run build_runner test -- -p vm test/configurable_uri_test.dart --test-randomize-ordering-seed=random`]"
      dart: dev
      os: windows
      env: PKGS="_test"
      script: tool/ci.sh command_0 command_1
    - stage: unit_test
      name: "SDK: dev; PKG: build; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: dev
      os: linux
      env: PKGS="build"
      script: tool/ci.sh test_06
    - stage: unit_test
      name: "SDK: dev; PKG: build; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: dev
      os: windows
      env: PKGS="build"
      script: tool/ci.sh test_06
    - stage: unit_test
      name: "SDK: dev; PKG: build_config; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: dev
      os: linux
      env: PKGS="build_config"
      script: tool/ci.sh test_06
    - stage: unit_test
      name: "SDK: dev; PKG: build_config; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: dev
      os: windows
      env: PKGS="build_config"
      script: tool/ci.sh test_06
    - stage: unit_test
      name: "SDK: dev; PKG: build_daemon; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: dev
      os: linux
      env: PKGS="build_daemon"
      script: tool/ci.sh test_06
    - stage: unit_test
      name: "SDK: dev; PKG: build_daemon; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: dev
      os: windows
      env: PKGS="build_daemon"
      script: tool/ci.sh test_06
    - stage: unit_test
      name: "SDK: dev; PKG: build_modules; TASKS: `pub run test -P presubmit --test-randomize-ordering-seed=random`"
      dart: dev
      os: linux
      env: PKGS="build_modules"
      script: tool/ci.sh test_07
    - stage: unit_test
      name: "SDK: dev; PKG: build_modules; TASKS: `pub run test -P presubmit --test-randomize-ordering-seed=random`"
      dart: dev
      os: windows
      env: PKGS="build_modules"
      script: tool/ci.sh test_07
    - stage: unit_test
      name: "SDK: dev; PKG: build_resolvers; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: dev
      os: linux
      env: PKGS="build_resolvers"
      script: tool/ci.sh test_06
    - stage: unit_test
      name: "SDK: dev; PKG: build_resolvers; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: dev
      os: windows
      env: PKGS="build_resolvers"
      script: tool/ci.sh test_06
    - stage: unit_test
      name: "SDK: dev; PKG: build_runner; TASKS: `pub run test -x integration --test-randomize-ordering-seed=random`"
      dart: dev
      os: linux
      env: PKGS="build_runner"
      script: tool/ci.sh test_08
    - stage: unit_test
      name: "SDK: 2.9.0; PKG: build_runner_core; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: "2.9.0"
      os: linux
      env: PKGS="build_runner_core"
      script: tool/ci.sh test_06
    - stage: unit_test
      name: "SDK: 2.9.0; PKG: build_runner_core; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: "2.9.0"
      os: windows
      env: PKGS="build_runner_core"
      script: tool/ci.sh test_06
    - stage: unit_test
      name: "SDK: dev; PKG: build_runner_core; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: dev
      os: linux
      env: PKGS="build_runner_core"
      script: tool/ci.sh test_06
    - stage: unit_test
      name: "SDK: dev; PKG: build_runner_core; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: dev
      os: windows
      env: PKGS="build_runner_core"
      script: tool/ci.sh test_06
    - stage: unit_test
      name: "SDK: dev; PKG: build_test; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: dev
      os: linux
      env: PKGS="build_test"
      script: tool/ci.sh test_06
    - stage: unit_test
      name: "SDK: dev; PKG: build_test; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: dev
      os: windows
      env: PKGS="build_test"
      script: tool/ci.sh test_06
    - stage: unit_test
      name: "SDK: dev; PKG: build_vm_compilers; TASKS: `pub run test`"
      dart: dev
      os: linux
      env: PKGS="build_vm_compilers"
      script: tool/ci.sh test_05
    - stage: unit_test
      name: "SDK: dev; PKG: build_vm_compilers; TASKS: `pub run test`"
      dart: dev
      os: windows
      env: PKGS="build_vm_compilers"
      script: tool/ci.sh test_05
    - stage: unit_test
      name: "SDK: dev; PKG: build_web_compilers; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: dev
      os: linux
      env: PKGS="build_web_compilers"
      script: tool/ci.sh test_06
    - stage: unit_test
      name: "SDK: dev; PKG: build_web_compilers; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: dev
      os: windows
      env: PKGS="build_web_compilers"
      script: tool/ci.sh test_06
    - stage: unit_test
      name: "SDK: dev; PKG: scratch_space; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: dev
      os: linux
      env: PKGS="scratch_space"
      script: tool/ci.sh test_06
    - stage: unit_test
      name: "SDK: dev; PKG: scratch_space; TASKS: `pub run test --test-randomize-ordering-seed=random`"
      dart: dev
      os: windows
      env: PKGS="scratch_space"
      script: tool/ci.sh test_06
    - stage: e2e_test
      name: "SDK: dev; PKG: _test; TASKS: `pub run test --total-shards 2 --shard-index 0 --test-randomize-ordering-seed=random`"
      dart: dev
      os: linux
      env: PKGS="_test"
      script: tool/ci.sh test_00
    - stage: e2e_test
      name: "SDK: dev; PKG: _test; TASKS: `pub run test --total-shards 2 --shard-index 1 --test-randomize-ordering-seed=random`"
      dart: dev
      os: linux
      env: PKGS="_test"
      script: tool/ci.sh test_01
    - stage: e2e_test
      name: "SDK: dev; PKG: _test; TASKS: `pub run test --total-shards 3 --shard-index 0 --test-randomize-ordering-seed=random`"
      dart: dev
      os: windows
      env: PKGS="_test"
      script: tool/ci.sh test_02
    - stage: e2e_test
      name: "SDK: dev; PKG: _test; TASKS: `pub run test --total-shards 3 --shard-index 1 --test-randomize-ordering-seed=random`"
      dart: dev
      os: windows
      env: PKGS="_test"
      script: tool/ci.sh test_03
    - stage: e2e_test
      name: "SDK: dev; PKG: _test; TASKS: `pub run test --total-shards 3 --shard-index 2 --test-randomize-ordering-seed=random`"
      dart: dev
      os: windows
      env: PKGS="_test"
      script: tool/ci.sh test_04
    - stage: e2e_test
      name: "SDK: dev; PKG: _test_null_safety; TASKS: [`pub run build_runner test --enable-experiment=non-nullable -- -p chrome,vm --test-randomize-ordering-seed=random`, `pub run build_runner test --enable-experiment=non-nullable --define=\"build_web_compilers:entrypoint=compiler=dart2js\" -- -p chrome --test-randomize-ordering-seed=random`]"
      dart: dev
      os: linux
      env: PKGS="_test_null_safety"
      script: tool/ci.sh command_2 command_3
    - stage: e2e_test
      name: "SDK: dev; PKG: build_runner; TASKS: `pub run test -t integration --total-shards 5 --shard-index 0 --test-randomize-ordering-seed=random --no-chain-stack-traces`"
      dart: dev
      os: linux
      env: PKGS="build_runner"
      script: tool/ci.sh test_09
    - stage: e2e_test
      name: "SDK: dev; PKG: build_runner; TASKS: `pub run test -t integration --total-shards 5 --shard-index 1 --test-randomize-ordering-seed=random --no-chain-stack-traces`"
      dart: dev
      os: linux
      env: PKGS="build_runner"
      script: tool/ci.sh test_10
    - stage: e2e_test
      name: "SDK: dev; PKG: build_runner; TASKS: `pub run test -t integration --total-shards 5 --shard-index 2 --test-randomize-ordering-seed=random --no-chain-stack-traces`"
      dart: dev
      os: linux
      env: PKGS="build_runner"
      script: tool/ci.sh test_11
    - stage: e2e_test
      name: "SDK: dev; PKG: build_runner; TASKS: `pub run test -t integration --total-shards 5 --shard-index 3 --test-randomize-ordering-seed=random --no-chain-stack-traces`"
      dart: dev
      os: linux
      env: PKGS="build_runner"
      script: tool/ci.sh test_12
    - stage: e2e_test
      name: "SDK: dev; PKG: build_runner; TASKS: `pub run test -t integration --total-shards 5 --shard-index 4 --test-randomize-ordering-seed=random --no-chain-stack-traces`"
      dart: dev
      os: linux
      env: PKGS="build_runner"
      script: tool/ci.sh test_13
    - stage: e2e_test_cron
      name: "SDK: be/raw/latest; PKG: _test; TASKS: `pub run test`"
      dart: be/raw/latest
      os: linux
      env: PKGS="_test"
      script: tool/ci.sh test_05
    - stage: e2e_test_cron
      name: "SDK: be/raw/latest; PKG: _test; TASKS: `pub run test`"
      dart: be/raw/latest
      os: windows
      env: PKGS="_test"
      script: tool/ci.sh test_05
    - stage: e2e_test_cron
      name: "SDK: dev; PKG: _test; TASKS: `pub run test`"
      dart: dev
      os: linux
      env: PKGS="_test"
      script: tool/ci.sh test_05
    - stage: e2e_test_cron
      name: "SDK: dev; PKG: _test; TASKS: `pub run test`"
      dart: dev
      os: windows
      env: PKGS="_test"
      script: tool/ci.sh test_05
    - stage: e2e_test_cron
      name: "SDK: be/raw/latest; PKG: _test_null_safety; TASKS: [`pub run build_runner test --enable-experiment=non-nullable -- -p chrome,vm --test-randomize-ordering-seed=random`, `pub run build_runner test --enable-experiment=non-nullable --define=\"build_web_compilers:entrypoint=compiler=dart2js\" -- -p chrome --test-randomize-ordering-seed=random`]"
      dart: be/raw/latest
      os: linux
      env: PKGS="_test_null_safety"
      script: tool/ci.sh command_2 command_3
    - stage: e2e_test_cron
      name: "SDK: be/raw/latest; PKG: _test_null_safety; TASKS: [`pub run build_runner test --enable-experiment=non-nullable -- -p chrome,vm --test-randomize-ordering-seed=random`, `pub run build_runner test --enable-experiment=non-nullable --define=\"build_web_compilers:entrypoint=compiler=dart2js\" -- -p chrome --test-randomize-ordering-seed=random`]"
      dart: be/raw/latest
      os: windows
      env: PKGS="_test_null_safety"
      script: tool/ci.sh command_2 command_3
    - stage: e2e_test_cron
      name: "SDK: dev; PKG: _test_null_safety; TASKS: [`pub run build_runner test --enable-experiment=non-nullable -- -p chrome,vm --test-randomize-ordering-seed=random`, `pub run build_runner test --enable-experiment=non-nullable --define=\"build_web_compilers:entrypoint=compiler=dart2js\" -- -p chrome --test-randomize-ordering-seed=random`]"
      dart: dev
      os: linux
      env: PKGS="_test_null_safety"
      script: tool/ci.sh command_2 command_3
    - stage: e2e_test_cron
      name: "SDK: dev; PKG: _test_null_safety; TASKS: [`pub run build_runner test --enable-experiment=non-nullable -- -p chrome,vm --test-randomize-ordering-seed=random`, `pub run build_runner test --enable-experiment=non-nullable --define=\"build_web_compilers:entrypoint=compiler=dart2js\" -- -p chrome --test-randomize-ordering-seed=random`]"
      dart: dev
      os: windows
      env: PKGS="_test_null_safety"
      script: tool/ci.sh command_2 command_3

stages:
  - analyze_and_format
  - unit_test
  - e2e_test
  - name: e2e_test_cron
    if: "type IN (api, cron)"

cache:
  directories:
    - "$HOME/.pub-cache"
    - build/.dart_tool/build
    - build_config/.dart_tool/build
    - build_modules/.dart_tool/build
    - build_resolvers/.dart_tool/build
    - build_test/.dart_tool/build
    - scratch_space/.dart_tool/build
